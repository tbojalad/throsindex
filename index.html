<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Throws PR Tracker + Leaderboard</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body style="font-family:system-ui,Arial;margin:20px;">
  <h2>Throws PR Tracker + Leaderboard</h2>
  <div id="auth">
    <input id="email" type="email" placeholder="Enter email">
    <button id="login">Send Magic Link</button>
    <p id="authMsg"></p>
  </div>
  <div id="app" style="display:none;">
    <p id="user"></p>
    <button id="logout">Sign out</button>
    <h3>Add PR</h3>
    <select id="event"><option>Shot Put</option><option>Discus</option><option>Hammer</option><option>Weight</option></select>
    <input id="wt" type="number" placeholder="Weight">
    <input id="dist" type="number" placeholder="Distance">
    <button id="savePR">Save</button>
    <p id="msg"></p>
    <h3>My PRs</h3>
    <div id="myPRs"></div>
  </div>

<script>
const supabase = window.supabase.createClient(
  "https://kxlyznicrimozmdsdxyt.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4bHl6bmljcmltb3ptZHNkeHl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NTkyNzIsImV4cCI6MjA3MjUzNTI3Mn0.YS_k41cHlr3seq_3ttfMckadMpGxZ62LpFFIzpbdHZM"
);

const REDIRECT = "https://tbojalad.github.io/throsindex/";

// ðŸ”¹ Check if already signed in on page load
async function checkSession() {
  const { data: { session } } = await supabase.auth.getSession();
  if (session?.user) {
    showApp(session.user);
  } else {
    document.getElementById('auth').style.display = 'block';
    document.getElementById('app').style.display = 'none';
  }
}
checkSession();

// ðŸ”¹ Also respond to changes in auth state
supabase.auth.onAuthStateChange((_event, session) => {
  if (session?.user) {
    showApp(session.user);
  } else {
    document.getElementById('auth').style.display = 'block';
    document.getElementById('app').style.display = 'none';
  }
});

document.getElementById('login').onclick = async () => {
  const email = document.getElementById('email').value;
  const { error } = await supabase.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: REDIRECT }
  });
  document.getElementById('authMsg').textContent = error ? error.message : "Check your email for login link";
};

document.getElementById('logout').onclick = async () => {
  await supabase.auth.signOut();
  location.reload();
};

// ðŸ”¹ Show the logged-in app
function showApp(user) {
  document.getElementById('auth').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('user').textContent = "Signed in as " + (user.email || "");
  loadPRs();
}

document.getElementById('savePR').onclick = async () => {
  const ev = document.getElementById('event').value;
  const wt = parseFloat(document.getElementById('wt').value);
  const dist = parseFloat(document.getElementById('dist').value);
  const { data: { user } } = await supabase.auth.getUser();
  const { error } = await supabase.from('prs').insert({
    user_id: user.id,
    event: ev,
    implement_weight: wt,
    weight_unit: "lb",
    distance: dist,
    distance_unit: "ft"
  });
  document.getElementById('msg').textContent = error ? error.message : "Saved!";
  loadPRs();
};

async function loadPRs() {
  const { data, error } = await supabase.from('prs').select('*').order('created_at', { ascending: false }).limit(20);
  if (error) { document.getElementById('myPRs').textContent = error.message; return; }
  document.getElementById('myPRs').innerHTML = "<ul>" + data.map(r => `<li>${r.event}: ${r.distance} ${r.distance_unit}</li>`).join('') + "</ul>";
}
<script>
const supabase = window.supabase.createClient(
  "https://kxlyznicrimozmdsdxyt.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt4bHl6bmljcmltb3ptZHNkeHl0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NTkyNzIsImV4cCI6MjA3MjUzNTI3Mn0.YS_k41cHlr3seq_3ttfMckadMpGxZ62LpFFIzpbdHZM"
);

const REDIRECT = "https://tbojalad.github.io/throsindex/";

// ðŸŸ¢ Check session on every page load
async function initAuth() {
  const { data: { session } } = await supabase.auth.getSession();
  if (session?.user) {
    showApp(session.user);
  } else {
    showLogin();
  }
}

// ðŸŸ¢ Also listen for changes after magic link
supabase.auth.onAuthStateChange((_event, session) => {
  if (session?.user) {
    showApp(session.user);
  } else {
    showLogin();
  }
});

document.getElementById('login').onclick = async () => {
  const email = document.getElementById('email').value;
  const { error } = await supabase.auth.signInWithOtp({
    email,
    options: { emailRedirectTo: REDIRECT }
  });
  document.getElementById('authMsg').textContent =
    error ? error.message : "Check your email for login link";
};

document.getElementById('logout').onclick = async () => {
  await supabase.auth.signOut();
  showLogin();
};

// ðŸ”¹ Helpers
function showApp(user) {
  document.getElementById('auth').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  document.getElementById('user').textContent =
    "Signed in as " + (user.email || "");
  loadPRs();
}

function showLogin() {
  document.getElementById('auth').style.display = 'block';
  document.getElementById('app').style.display = 'none';
}

document.getElementById('savePR').onclick = async () => {
  const ev = document.getElementById('event').value;
  const wt = parseFloat(document.getElementById('wt').value);
  const dist = parseFloat(document.getElementById('dist').value);
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) { alert("Please log in first"); return; }
  const { error } = await supabase.from('prs').insert({
    user_id: user.id,
    event: ev,
    implement_weight: wt,
    weight_unit: "lb",
    distance: dist,
    distance_unit: "ft"
  });
  document.getElementById('msg').textContent =
    error ? error.message : "Saved!";
  loadPRs();
};

async function loadPRs() {
  const { data, error } = await supabase.from('prs')
    .select('*')
    .order('created_at', { ascending: false })
    .limit(20);
  if (error) {
    document.getElementById('myPRs').textContent = error.message;
    return;
  }
  document.getElementById('myPRs').innerHTML =
    "<ul>" +
    data.map(r => `<li>${r.event}: ${r.distance} ${r.distance_unit}</li>`).join('') +
    "</ul>";
}

// Run auth init on page load
initAuth();
</script>
